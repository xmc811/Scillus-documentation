---
title: "Data Processing"
author: "Mingchu Xu"
date: 2021-04-17

output: html_document
---

### Loading Raw Data

To load scRNA-seq raw data:

```{r echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', eval=FALSE}
library(Scillus)
library(tidyverse)
library(Seurat)
library(magrittr)

scRNA <- load_scfile(m)
```

Scillus will create `Seurat` object for each sample and automatically call `PercentageFeatureSet()` function to calculate the mitochondrial gene percentage. The resulting `scRNA` is a list of multiple Seurat objects. Its length equals to number of rows of metadata `m`:

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
length(scRNA)
```

### Plotting QC Measures

The QC Measures can be plotted by `plot_qc()`. The resulting plot can be further customized (axis.title, theme, etc.) using ggplot grammar.


```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Mitochondria gene percentage in each sample", fig.height=3, fig.width=6}
plot_qc(scRNA, metrics = "percent.mt")
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Number of genes detected in each sample", fig.height=3, fig.width=6}
plot_qc(scRNA, metrics = "nFeature_RNA")
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Number of UMIs in each sample", fig.height=3, fig.width=6}
plot_qc(scRNA, metrics = "nCount_RNA")
```

There are 3 optional parameters for `plot_qc()`: `plot_type`, `group_by`, and `pal_setup`.

The default value of `plot_type` is `"combined"`, meaning both box plot and violin plot are drawn. If only one of the two plots is preferred, it can be set as `"box"` or `"violin"`.

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Mitochondria gene percentage in each sample (Box plot)", fig.height=3, fig.width=6}
plot_qc(scRNA, metrics = "percent.mt", plot_type = "box")
```

`"density"` is used to draw density plot. Notice that additional ggplot grammar (log transformation here) can be added.


```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Number of UMIs in each sample (Density plot, log10 transformed)", fig.height=3, fig.width=6}
plot_qc(scRNA, metrics = "nCount_RNA", plot_type = "density") + scale_x_log10()
```

The default value of `group_by` is `"sample"`, which corresponds to the `sample` column in the metadata `m`. Since additional metadata are included in the loading process, QC measures can also be plotted by those additional factors, like `"group"` (which corresponds to `group` column in the metadata `m`).

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Number of UMIs in each group", fig.height=3, fig.width=4}
plot_qc(scRNA, metrics = "percent.mt", group_by = "group")
```

The parameter `pal_setup` supports three types of inputs: `RColorBrewer` palette name, palette setup dataframe (See [Initial Setup](configuration.html), the last section), and manually specified color vector. The default value is the palette `"Set2"`.

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Mitochondrial read percentage in each group (RColorBrewer palette name as palette input)", fig.height=3, fig.width=4}
plot_qc(scRNA, metrics = "percent.mt", group_by = "group", pal_setup = "Accent")
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Mitochondrial read percentage in each group (Configured dataframe as palette input)", fig.height=3, fig.width=4}
plot_qc(scRNA, metrics = "percent.mt", group_by = "group", pal_setup = pal)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Mitochondrial read percentage in each group (Manually specified colors as palette input)", fig.height=3, fig.width=4}
plot_qc(scRNA, metrics = "percent.mt", group_by = "group", pal_setup = c("purple","yellow"))
```


### Filtering and Integration

The function `filter_scdata()` is used for Seurat object subsetting. The grammar of `subset` parameter is the same as `subset()` function for Seurat object. A bar plot will be automatically drawn to show the number of cells before and after filtering.

```{r eval=FALSE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
scRNA_f <- filter_scdata(scRNA, subset = nFeature_RNA > 500 & percent.mt < 10)
```
```{r eval=TRUE, echo=FALSE, warning=FALSE, paged.print=TRUE, results='asis', fig.align='center', fig.cap="Number of cells before and after filtering", fig.height=4.5, fig.width=7}
tmp <- filter_scdata(scRNA, subset = nFeature_RNA > 500 & percent.mt < 10)
rm(tmp)
```

The list of filtered Seurat objects `scRNA_f` will be further processed by standard Seurat pipeline:

```{r eval=FALSE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
scRNA_f %<>% 
        purrr::map(.f = NormalizeData) %>%
        purrr::map(.f = FindVariableFeatures) %>%
        purrr::map(.f = CellCycleScoring, 
                   s.features = cc.genes$s.genes, 
                   g2m.features = cc.genes$g2m.genes)
```

The list of Seurat objects `scRNA_f` can be merged to one single Seurat object `scRNA_int` for integrated analysis: 

```{r eval=FALSE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
scRNA_int <- IntegrateData(anchorset = FindIntegrationAnchors(object.list = scRNA_f, dims = 1:30, k.filter = 50), dims = 1:30)
```

```{r eval=FALSE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
scRNA_int %<>%
        ScaleData(vars.to.regress = c("nCount_RNA", "percent.mt", "S.Score", "G2M.Score"))

scRNA_int %<>%
        RunPCA(npcs = 50, verbose = TRUE)

scRNA_int %<>%
        RunUMAP(reduction = "pca", dims = 1:20, n.neighbors = 30) %>%
        FindNeighbors(reduction = "pca", dims = 1:20) %>%
        FindClusters(resolution = 0.3)
```

### Factoring

Factoring Seurat object metadata by `refactor_seurat()` is an optional step, mainly for better plotting. The function takes the metadata `m` as argument and make the Seurat object metadata the same factor levels as those in `m`. If no `metadata` parameter is provided. All the character vectors in Seurat object metadata will be factored.

```{r eval=FALSE, echo=TRUE, warning=FALSE, paged.print=TRUE, results='asis'}
m %<>%
        mutate(group = factor(group, levels = c("Normal", "CTCL")))

scRNA_int %<>%
        refactor_seurat(metadata = m)
```

